version: "3.7"
services:
    ssh-client:
        user: "1000:0"
        build:
            context: .
            dockerfile: ./Dockerfile-ssh-client
        command: ["autossh", "-M", "0", "-T", "-N", "-4", "pbktunnel"]
        environment:
            SSH_AUTH_SOCK: /ssh-agent/ssh-agent.sock
        volumes:
            - ssh-agent:/ssh-agent
            - .ssh:/home/appuser/.ssh:ro
        restart: unless-stopped
        labels:
            - autoheal=true
        healthcheck:
            test: [ "CMD", "ssh", "-q", "-o", "BatchMode=yes", "-o", "StrictHostKeyChecking=no", "-o", "ConnectTimeout=5", "healthcheck", "'exit 0'" ]
            interval: 1m30s
            timeout: 10s
            retries: 3
            start_period: 40s
    autoheal:
        restart: always
        image: willfarrell/autoheal
        environment:
            - AUTOHEAL_CONTAINER_LABEL=all
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
volumes:
    ssh-agent:
        external: true
networks:
    default:
        name: paha-gaming-ssh-forwarding
